export default {
  async fetch(request, env) {
    const { pathname } = new URL(request.url);

    if (request.method === "POST" && pathname === "/shorten") {
      const data = await request.json();
      let { url, customCode } = data;

      if (!url || !/^https?:\/\//.test(url)) {
        return new Response(JSON.stringify({ error: "è¯·è¾“å…¥åˆæ³•çš„ç½‘å€" }), {
          headers: { "Content-Type": "application/json" },
          status: 400,
        });
      }

      let shortCode = customCode || Math.random().toString(36).substring(2, 8);

      // æ£€æŸ¥è‡ªå®šä¹‰çŸ­ç æ˜¯å¦å·²å­˜åœ¨
      if (await env.url.get(shortCode)) {
        return new Response(JSON.stringify({ error: "çŸ­ç å·²å­˜åœ¨ï¼Œè¯·æ¢ä¸€ä¸ª" }), {
          headers: { "Content-Type": "application/json" },
          status: 400,
        });
      }

      await env.url.put(shortCode, url);
      return new Response(JSON.stringify({ shortUrl: `${new URL(request.url).origin}/${shortCode}` }), {
        headers: { "Content-Type": "application/json" },
      });
    }

    // çŸ­é“¾è·³è½¬é€»è¾‘
    if (pathname !== "/") {
      const code = pathname.slice(1);
      const target = await env.url.get(code);
      if (target) {
        return Response.redirect(target, 302);
      }
      return new Response("çŸ­é“¾ä¸å­˜åœ¨", { status: 404 });
    }

    // å‰ç«¯é¡µé¢
    return new Response(
      `<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>çŸ­é“¾ç”Ÿæˆå™¨</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #74ebd5 0%, #ACB6E5 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container {
      background: white;
      padding: 30px 25px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    h1 {
      margin-bottom: 20px;
      font-size: 1.6em;
      color: #333;
    }
    input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 15px;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #357ABD;
    }
    .result {
      margin-top: 20px;
      word-wrap: break-word;
      display: none;
    }
    .short-url {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
      padding: 10px;
      background: #f4f4f4;
      border-radius: 8px;
      font-size: 14px;
    }
    .copy-btn {
      background: #34c759;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }
    @media (max-width: 480px) {
      .container {
        padding: 20px;
      }
      h1 {
        font-size: 1.3em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”— çŸ­é“¾ç”Ÿæˆå™¨</h1>
    <input type="text" id="urlInput" placeholder="è¾“å…¥ç½‘å€ (å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´)" />
    <input type="text" id="customInput" placeholder="è‡ªå®šä¹‰çŸ­ç  (å¯é€‰)" />
    <button onclick="shortenUrl()">ç”ŸæˆçŸ­é“¾</button>
    <div class="result" id="resultBox">
      <p>âœ… ç”ŸæˆæˆåŠŸï¼š</p>
      <div class="short-url">
        <span id="shortUrl"></span>
        <button class="copy-btn" onclick="copyUrl()">å¤åˆ¶</button>
      </div>
    </div>
  </div>
  <script>
    async function shortenUrl() {
      const url = document.getElementById("urlInput").value.trim();
      const customCode = document.getElementById("customInput").value.trim();
      if (!url) return alert("è¯·è¾“å…¥ç½‘å€");
      const res = await fetch("/shorten", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url, customCode })
      });
      const data = await res.json();
      if (data.error) {
        alert(data.error);
      } else {
        document.getElementById("shortUrl").textContent = data.shortUrl;
        document.getElementById("resultBox").style.display = "block";
      }
    }
    function copyUrl() {
      const text = document.getElementById("shortUrl").textContent;
      navigator.clipboard.writeText(text).then(() => {
        alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
      });
    }
  </script>
</body>
</html>`,
      { headers: { "Content-Type": "text/html;charset=UTF-8" } }
    );
  }
};
